# 汇编大作业说明文档

## 小组成员

选题：汇编游戏 INVERSUS

林欣涛 软件01 2020012356

朱思漠 软件92 2018012209

杜家锟 软件01 2020010795

## 开发环境

操作系统：Windows 10

集成开发环境：Visual Studio（2012、2019与2022三个版本均可运行）

运行方法：安装MASM32，导入附加依赖项Irvine32，完成汇编环境配置。在Visual Studio中就可以使用Debug或Release模式运行并生成.exe文件。

文件结构说明：

- `src`文件夹下存放代码文件，包括`.asm`汇编文件与资源文件。

- `exe`文件夹下存放可执行文件，包括`.exe`可执行文件以及运行说明`readme.txt`。

- `doc`文件夹下存放说明文件。

## 实现原理

### 原理总述

我们使用汇编语言，调用Win32相关API实现绘图、键盘控制、音效播放、定时器等用户交互功能，实现两个玩家对战的游戏功能。

### 窗口绘制

绘图主要参考了[Win32 API官方文档](https://learn.microsoft.com/zh-cn/windows/win32/api/)，使用画刷直接绘制色块+直接显示图片两种方式实现。

对于选关界面这种需要查看所有关卡大体情况的界面，由于具体图像难以直接用画刷绘制，所以我们通过直接插入各个关卡截图的方式实现。

对于其他界面，包括菜单界面、游戏界面、帮助界面、自定义颜色界面，我们都选择使用画刷绘制实现。这种实现方式使得我们的程序具有极大的可扩展性。（这一点在创新点会详细描述）

为了解决中期时出现的屏幕闪烁问题，我们采取了先将所有需要绘制的元素绘制到一张”布局页面”句柄上，最后再将“布局页面”整个绘制到屏幕上的方式。这样减少了在屏幕上绘制的次数，从而使得屏幕的显示更加稳定。

### 按键响应

按键识别部分是在消息循环当中，识别`wm_keydown`和`wm_keyup`信息，使其跳转执行对应的消息处理过程。在`keydownmessage`中，通过查找资料获取键盘按键的字符码，与按键信息的下一位键盘信息进行比较，如果比对成功，则标记该键的状态为1，如果比对不成功则直接结束按键消息；同样的，在`keyupmessage`中，通过与案件信息的下一位键盘信息进行比较，如果比对成功，则标记该键的状态位0，如果比对不成功则直接结束按键消息。

### 定时器信息

定时器的设置需要在窗口创建的时候就开始设置，在窗口关闭时候kill掉，通过定时器回调，实现了每30ms刷新方块位置信息、子弹位置信息和地图信息等数据，并调用重绘函数重新绘制黑白主角、子弹与地图。

### 方块移动

在定时器回调函数当中，逐一判断每一个按键的状态是否为1（按下），如果按下就修改其数值，没有按下就跳过，这样紧随其后的窗口重绘函数就会调用画图函数重新绘制黑白主角的位置，实现平滑移动的效果，同时按键的持续时间越长，移动的距离越远。

### 子弹射击

我们将子弹射击与后续判定两个过程解耦成两个函数

- `emitBullet`函数在攻击键被按下时调用，它的作用是向地图中加入一发子弹，其位置、方向、颜色均取决于发射它的角色当前的状态。同时，程序将会新创建一个线程用来播放音效。
- `updateBullets`则负责对场上所有子弹的状态进行更新，包括但不限于更新子弹位置、双方子弹对冲抵消、子弹射出地图后清除、子弹导致的路径变色、路径变色导致的敌方角色死亡。`updateBullets`在定时器函数中被调用，使得子弹的更新也是平滑的。

此外，子弹的冷却功能借助计时器函数实现，每当一个计时器周期（30ms）到来时，计数器将加一。当计数器的值达到50时（即1.5秒后），计数器将清零，并令子弹数加一。

### 游戏暂停

在游戏过程中，如果esc键被按下，将会使得游戏标志位`statusFlag`置为3，代表了游戏当前处于暂停状态。而计时器函数在执行前将检测这个标志位，当`statusFlag`值为3时，计时器函数直接退出，不做任何事。于是，所有的角色控制操作都无法响应，依赖于计时器调用的子弹更新函数`updateBullets`也无法运行，从而实现了暂停的效果。

### 颜色自定义

为了实现颜色自定义功能，我们修改了角色显示的方式。我们最初的实现是将角色的图片直接画在屏幕上，但这样的方法难以扩展，如果想要改变角色的颜色，就必须重新找一张图片，除此之外，20张图片的载入也会导致程序的体积过于臃肿。于是，我们选择用画刷绘制角色的方式代替直接使用图片绘制角色，从而我们只需要改变画刷使用的颜色句柄，就可以实现颜色的切换。这样的方式更易于扩展，例如，当时刚做出来此功能时，在选取的20种颜色中有两对颜色较为接近，如果同时被选择则容易“看不清”。但是修改起来极为方便，我们只需要修改`const.inc`中的颜色数组，就可以快速地改变颜色，省去了重新找资源文件的过程。

## 难点和创新点

### 难点一：图形界面绘制

由于我们的项目是游戏，而游戏最重要的就是游戏体验，而用户最直观的游戏体验就是图形界面。因此在我们项目的初期，图形界面的绘制就是我们小组攻坚的重中之重。起初，由于我们对Win32 绘图相关API的不熟悉，我们连一个基本的图片绘制都成问题。后来，经过几天的摸索，我们成功显示了第一张图片，之后我们才将基本的游戏界面绘制出来。

然而这还不够。当时我们只能实现“能看”，但体验不佳——整个屏幕的显示总是在不停地闪烁。我们对这个问题感到非常困惑，拖了一周都没有解决。于是，我们仔细重新研究了一下Win32 绘图相关API，并对绘图函数进行了重构，在重构后我们找到了解决问题的方法。我们新增加了一个“布局页面”句柄，它的作用是将所有需要绘制的元素先绘制到它上面，在所有元素都绘制完之后，再将它整个地绘制到屏幕上。这样的绘制方式，减少了直接在屏幕上绘制的次数，也解决了屏幕闪烁的问题，玩家的游戏体验大大提高。

### 难点二：项目架构搭建

由于我们使用的是汇编语言这样底层的语言，我们在项目架构搭建方面遇到一些问题。由于汇编缺少面向对象的能力，我们的代码很容易出现大段的“屎山”，而变成“readonly”的代码。这在项目的中期给我们带来了不少困扰。我们最后解决问题的方式是重构代码，使用更具意义的变量命名、添加大量的注释等。

### 创新点一：角色的平滑移动控制与打击感

我们为了让玩家在玩我们的游戏时有更加流畅且“爽快”的游戏体验， 在对角色的移动攻击方面做了很多努力。

首先是移动方面，最简单的实现方式莫过于“闪现式”的移动，但我们不满足于此，通过使用计时器实现对用户的按键输入高频检测，进而高频且低粒度地更新角色的位置，使得角色的移动趋于平滑。

其次是攻击方面。我们同样使用计时器对发射的子弹位置进行更新，使得子弹的射击也趋于平滑。除此之外，为了能让玩家对“攻击”有一个直观的反馈，我们为每次攻击加上了音效。在开启音效的情况下，整场战斗将变得无比“带感”，游戏体验大大提高。

### 创新点二：独特的攻击判定逻辑

INVERSUS是一款射击游戏。而射击游戏一般的攻击判定逻辑都是以是否直接击中对方为判定依据。但我们从玩家只能在与自己颜色相反的区域内移动这一基本设定出发，研究出了新的判定逻辑——子弹并不直接对玩家造成伤害，子弹的唯一作用只是使得其路径变色。而一旦敌方角色有部分或全部像素处于变色的路径时，这意味着该角色所处的位置“不合法”，从而判定其被击败。

这样的判定规则，在具体表现上与传统的射击游戏存在差异：子弹无需“直接击中”目标也能造成击杀。此外，这样的判定规则，也与我们游戏的基本设定相辅相成：玩家只能在与自己反色的区域内移动。从而己方能移动的区域越大，则敌方能移动的区域越小。因此，通过子弹“开疆拓土”，在扩宽自己“活路”的同时限制敌方移动，是本游戏“制胜的法宝”。这样的设计有别于传统的射击游戏，使得我们的游戏独树一帜。

### 创新点三：创新性与可拓展性强

我们的游戏取材自switch游戏INVERSUS Deluxe。但是我们没有直接照搬照抄，而是在其基础上做了自己的发挥。界面的高度个性化就是其中之一，我们为玩家提供了多达**20**种颜色，玩家可以从中挑选自己喜欢的颜色作为自己的颜色。不仅如此，我们还支持设置背景色。如此高度的个性化，使得玩家具有多达**6840**种配色方式，可玩性极为丰富。除此之外，本游戏还留下了单人街机模式与双人联机模式的接口，给游戏的未来发展留下了更多的可能。

## 小组分工

林欣涛：按键识别与角色移动、绘制游戏界面与帮助界面、定时器处理函数、代码格式化

朱思漠：文档撰写、音效

杜家锟：游戏设计、菜单控制及绘制、子弹发射与相关判定、颜色自定义

## 与中期相比的进展

中期我们只实现了游戏的基本架构搭建，例如计时器函数、仅仅绘制了开始、模式选择和第一关卡三个页面、角色平滑移动（不包括位置合法性判断）、仅有2个菜单栏切换。当时的项目只能说“有个框架”，但绝没有到能玩的程度。与之相比，我们的最终项目有了很大提高。

- 新增功能
  - 使用画刷绘图代替大体积图片的显示，最后程序体积从原来的30多M缩减到不足2M，极大的缩小了游戏文件的体积
  - 包含位置合法性的角色移动
  - 详细的帮助界面和页面提示、按键提示等提示信息
  - 新增多个游戏地图以及地图选择界面，大大提高游戏的可玩性
  - 子弹发射、形状、移动、位置合法判定、击败、地图变色动画以及子弹对撞相消等多种功能
  - 设置了子弹的恢复冷却cd，以及子弹储备的显示，让玩家对于当前游戏局势有一个清晰的了解
  - 使用多线程异步播放设计音效，实现射击音效紧跟射击操作
  - 实现进入地图的游戏数据初始化，游戏的暂停、退出、继续等设计，胜利判定与胜利界面设计
  - 开创性设计了颜色自定义界面，让用户能够自己选择角色以及背景的颜色，增加游戏的趣味性和可玩性。而且，在该界面的光标操作以及边界判断经过特别设计，操作手感十分丝滑。
  - 新增关闭程序删除所有创建的句柄，保障内存安全
  - 游戏标题采用呼吸灯式的显示操作，同时增加了丰富的字体设计，让游戏界面更加美观
  - 设计了自己独有的icon游戏图标
  - 使用github管理代码，兼容三种版本的vs。详尽的代码迭代计划。[github仓库](https://github.com/linxt20/-INVERSUS_masm)
- 在代码结构方面，我们重构了中期前的代码，使得函数的逻辑更加清晰，这也为后续的扩展打好基础。事实上，颜色自定义功能即是在重构后的绘图函数基础上搭建的。我们还为每个用到的库函数与变量添加了注释，避免了团队开发过程中小组成员间，由于不了解对方使用的变量与函数而造成迷惑，甚至写出“屎山”代码的情况。游戏代码风格修改，将重复相似的代码段例如冲突处理、光标的边界处理等，抽象为函数以及将逻辑重复的代码理顺、重写，大大提高了代码的可读性、复用性以及利用率